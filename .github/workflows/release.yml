name: Build & Release EXE

permissions:
  contents: write

on:
  push:
    tags:
      - "*"

jobs:
  generate-notes:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Install Ollama
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh

      - name: Pull Llama 3B
        run: ollama pull llama3.2:3b

      - name: Determine commit range using remote tags
        id: commits
        run: |
          git fetch --tags --force

          # Read ONLY version-like tags (X.Y.Z)
          tags=($(git ls-remote --tags origin \
            | awk '{print $2}' \
            | sed 's|refs/tags/||' \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V))

          echo "Detected remote tags:"
          printf '%s\n' "${tags[@]}"

          if [ ${#tags[@]} -lt 2 ]; then
            echo "Not enough tags to compare."
            exit 1
          fi

          previous=${tags[-2]}
          current=${tags[-1]}

          echo "Previous tag: $previous"
          echo "Current tag : $current"

          ### NEW â€” Print GitHub compare link
          echo ""
          echo "### ðŸ” GitHub Compare URL"
          echo "https://github.com/${GITHUB_REPOSITORY}/compare/$previous...$current"
          echo ""

          ### NEW â€” Save full commit diffs with hashes
          git log "$previous..$current" --pretty=format:"%h %s" > commits_full.txt

          echo "### Commits with hashes:"
          cat commits_full.txt
          echo ""

          # Save messages only for AI
          git log "$previous..$current" --pretty=format:"- %s" > commits.txt

          echo "--- Commit messages collected for AI ---"
          cat commits.txt
          echo ""

      - name: Upload commit comparison artifact ### NEW
        uses: actions/upload-artifact@v4
        with:
          name: commit_diff
          path: commits_full.txt

      - name: Generate release notes using Llama 3B
        run: |
          commits=$(cat commits.txt)

          prompt="Convert the following commit messages into structured GitHub release notes:

          $commits

          Requirements:
          - Use clean GitHub Markdown
          - Group into: Features, Fixes, Improvements, GUI, Build, Misc
          - Only use the commit messages provided
          - No hallucinations
          - No emojis
          - No code blocks
          - Do NOT include top-level headings like # or ###
          - Text only inside sections"

          ollama run llama3.2:3b "$prompt" > release_notes.md

          echo "--- AI Generated Release Notes ---"
          cat release_notes.md

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release_notes
          path: release_notes.md

  build:
    runs-on: windows-latest
    needs: generate-notes

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/cache@v3
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Build KoniuBot.exe
        shell: pwsh
        run: |
          pyinstaller --onefile --noconsole --name KoniuBot src/main.py
          New-Item -ItemType Directory -Force -Path build
          Copy-Item -Force "dist/KoniuBot.exe" "build/KoniuBot.exe"

      # Download release notes generated by Ubuntu job
      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release_notes
          path: .

      - name: Prepare release notes for GitHub
        id: notes
        shell: bash
        run: |
          content=$(cat release_notes.md)

          # Escape for GitHub output
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}"

          echo "body=$content" >> $GITHUB_OUTPUT

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/KoniuBot.exe
          tag_name: ${{ github.ref_name }}
          name: "KoniuBot ${{ github.ref_name }}"
          body: ${{ steps.notes.outputs.body }}
