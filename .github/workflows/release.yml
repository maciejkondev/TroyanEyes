name: Build & Release EXE

permissions:
  contents: write

on:
  push:
    tags:
      - "*"

jobs:
  generate-notes:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Install Ollama
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
      - name: Pull Llama 3B
        run: ollama pull llama3.2:3b

      - name: Determine commit range using remote tags
        id: commits
        run: |
          git fetch --tags --force
          tags=($(git ls-remote --tags origin \
            | awk '{print $2}' \
            | sed 's|refs/tags/||' \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V))

          echo "Detected remote tags:"
          printf '%s\n' "${tags[@]}"

          if [ ${#tags[@]} -lt 2 ]; then
            echo "Only one tag detected â€“ skipping release notes generation."
            echo "" > release_notes.md
            exit 0
          fi

          previous=${tags[-2]}
          current=${tags[-1]}
          echo "Previous tag: $previous"
          echo "Current tag : $current"

          echo ""
          echo "### ðŸ” GitHub Compare URL"
          echo "https://github.com/${GITHUB_REPOSITORY}/compare/$previous...$current"
          echo ""

          git log "$previous..$current" --pretty=format:"%h %s" > commits_full.txt
          cat commits_full.txt

          git log "$previous..$current" --pretty=format:"- %s" > commits.txt
          cat commits.txt

      - name: Upload commit comparison artifact
        if: hashFiles('commits_full.txt') != ''
        uses: actions/upload-artifact@v4
        with:
          name: commit_diff
          path: commits_full.txt

      - name: Generate release notes using Llama 3B
        if: hashFiles('commits.txt') != ''
        run: |
          commits=$(cat commits.txt)
          prompt="Convert the following commit messages into structured GitHub release notes:
          $commits
          Requirements:
          - Use clean GitHub Markdown
          - Group into: Features, Fixes, Improvements, GUI, Build, Misc
          - Only use the commit messages provided
          - No hallucinations
          - No emojis
          - No code blocks
          - Do NOT include top-level headings like # or ###
          - Text only inside sections"

          ollama run llama3.2:3b "$prompt" > release_notes.md
          cat release_notes.md

      - name: Upload release notes artifact
        uses: actions/upload-artifact@v4
        with:
          name: release_notes
          path: release_notes.md


  build:
    runs-on: windows-latest
    needs: generate-notes

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/cache@v3
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Install PyInstaller
        run: pip install pyinstaller

      - name: Build TroyanEyes.exe
        shell: pwsh
        run: |
          pyinstaller --onefile --noconsole --name TroyanEyes src/main.py
          New-Item -ItemType Directory -Force -Path build
          Copy-Item -Force "dist/TroyanEyes.exe" "build/TroyanEyes.exe"

      - name: Build TEPatcher.exe
        shell: pwsh
        run: |
          pyinstaller --onefile --noconsole --name TEPatcher src/patcher.py
          Copy-Item -Force "dist/TEPatcher.exe" "build/TEPatcher.exe"

      # Download release notes generated by Ubuntu job
      - name: Download release notes
        uses: actions/download-artifact@v4
        with:
          name: release_notes
          path: .

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/TroyanEyes.exe
            build/TEPatcher.exe
          tag_name: ${{ github.ref_name }}
          name: "TroyanEyes ${{ github.ref_name }}"
          body_path: release_notes.md
